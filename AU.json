const { app, BrowserWindow, Tray, Menu, screen, net, dialog, nativeImage, ipcMain } = require('electron');
const path = require('path');
const fs = require('fs');

let win;
let tray;
let splashWindow;
let config = {};
let notificationWindows = [];
let trayContextMenu;
let isAppWindowCreated = false;
let iconTransitionWindow = null;

app.name = 'Nuro';

const configPath = path.join(app.getPath('userData'), 'config.json');

function loadConfig() {
    try {
        if (fs.existsSync(configPath)) {
            const configData = fs.readFileSync(configPath, 'utf8');
            return JSON.parse(configData);
        }
    } catch (error) {
        console.error('Error loading config:', error);
    }
    return { width: 400, side: 'right', alwaysOnTop: true, isFreeWindow: false, showSplash: true };
}

function saveConfig(newConfig) {
    try {
        config = { ...config, ...newConfig };
        fs.writeFileSync(configPath, JSON.stringify(config, null, 2));
    } catch (error) {
        console.error('Error saving config:', error);
    }
}

function createTrayIcon() {
    const image = nativeImage.createFromPath(path.join(__dirname, 'Nuro-Icon2.ico'));
    return image.resize({ width: 16, height: 16 });
}

function fetchConfig() {
    return new Promise((resolve) => {
        const request = net.request('https://raw.githubusercontent.com/ECCSco/Nuro_Configuration/refs/heads/main/config.json');
        request.on('response', (response) => {
            let data = '';
            response.on('data', (chunk) => {
                data += chunk;
            });
            response.on('end', () => {
                resolve(data.trim());
            });
        });
        request.on('error', () => resolve(null));
        request.end();
    });
}

function fetchURL(url) {
    return new Promise((resolve) => {
        const request = net.request(url);
        request.on('response', (response) => {
            let data = '';
            response.on('data', (chunk) => {
                data += chunk;
            });
            response.on('end', () => {
                resolve(data.trim());
            });
        });
        request.on('error', () => resolve(null));
        request.end();
    });
}

function showConnectionError() {
    dialog.showMessageBoxSync({
        type: 'error',
        title: 'Ошибка подключения',
        message: 'Сервис временно недоступен',
        detail: 'Приносим извинения за неудобства. Пожалуйста, повторите попытку позже.',
        buttons: ['Ок'],
        defaultId: 0,
        noLink: true,
        icon: path.join(__dirname, 'NuroIcon.ico')
    });
    
    app.isQuitting = true;
    app.quit();
}

function updateNotificationPositions() {
    const primaryDisplay = screen.getPrimaryDisplay();
    const { workArea } = primaryDisplay;
    const notificationHeight = 80;
    const padding = 10;
    
    notificationWindows.forEach((notificationWindow, index) => {
        if (notificationWindow && !notificationWindow.isDestroyed()) {
            const y = workArea.y + workArea.height - notificationHeight - padding - (index * (notificationHeight + padding));
            notificationWindow.setBounds({
                x: workArea.x + workArea.width - 320 - 10,
                y: Math.round(y),
                width: 320,
                height: notificationHeight
            }, false);
        }
    });
}

function showSystemNotification(title, message) {
    const primaryDisplay = screen.getPrimaryDisplay();
    const { workArea } = primaryDisplay;
    
    const notificationWidth = 320;
    const notificationHeight = 80;
    const padding = 10;
    
    const yPosition = workArea.y + workArea.height - notificationHeight - padding - (notificationWindows.length * (notificationHeight + padding));
    
    let notificationWindow = new BrowserWindow({
        width: notificationWidth,
        height: notificationHeight,
        x: workArea.x + workArea.width - notificationWidth - 10,
        y: Math.round(yPosition),
        frame: false,
        transparent: true,
        alwaysOnTop: true,
        skipTaskbar: true,
        resizable: false,
        movable: false,
        minimizable: false,
        maximizable: false,
        fullscreenable: false,
        show: false,
        focusable: false,
        webPreferences: {
            nodeIntegration: true,
            contextIsolation: false
        }
    });
    
    notificationWindow.setAlwaysOnTop(true, 'screen-saver');
    notificationWindow.setVisibleOnAllWorkspaces(true);
    
    notificationWindows.push(notificationWindow);
    
    const notificationHTML = `
        <!DOCTYPE html>
        <html>
        <head>
            <meta charset="UTF-8">
            <style>
                * {
                    margin: 0;
                    padding: 0;
                    box-sizing: border-box;
                    font-family: 'Segoe UI', Arial, sans-serif;
                }
                
                body {
                    width: 320px;
                    height: 80px;
                    background: rgba(0, 0, 0, 0.7);
                    backdrop-filter: blur(20px);
                    -webkit-backdrop-filter: blur(20px);
                    overflow: hidden;
                    box-shadow: 0 4px 20px rgba(0, 0, 0, 0.3);
                    color: white;
                    border: 1px solid rgba(255, 255, 255, 0.2);
                }
                
                .notification-content {
                    padding: 15px;
                    height: 100%;
                    display: flex;
                    flex-direction: column;
                    justify-content: center;
                }
                
                .notification-title {
                    font-size: 14px;
                    font-weight: 600;
                    margin-bottom: 5px;
                    color: #ffffff;
                }
                
                .notification-message {
                    font-size: 13px;
                    color: rgba(255, 255, 255, 0.9);
                    line-height: 1.4;
                }
                
                .notification-close {
                    position: absolute;
                    top: 4px;
                    right: 4px;
                    width: 24px;
                    height: 24px;
                    display: flex;
                    align-items: center;
                    justify-content: center;
                    cursor: pointer;
                    font-size: 20px;
                    color: rgba(255, 255, 255, 0.7);
                    transition: all 0.2s;
                    font-weight: 300;
                    background: transparent;
                    border-radius: 50%;
                }
                
                .notification-close:hover {
                    color: white;
                    transform: scale(1.2);
                }
                
                @keyframes slideIn {
                    from {
                        transform: translateX(100%);
                        opacity: 0;
                    }
                    to {
                        transform: translateX(0);
                        opacity: 1;
                    }
                }
                
                @keyframes fadeOut {
                    from {
                        opacity: 1;
                    }
                    to {
                        opacity: 0;
                    }
                }
            </style>
        </head>
        <body>
            <div class="notification-content">
                <div class="notification-close" onclick="window.closeNotification()">×</div>
                <div class="notification-title">${title}</div>
                <div class="notification-message">${message}</div>
            </div>
            <script>
                document.body.style.animation = 'slideIn 0.3s ease-out forwards';
                
                window.closeNotification = function() {
                    document.body.style.animation = 'fadeOut 0.3s ease-out forwards';
                    setTimeout(() => {
                        window.close();
                    }, 300);
                };
                
                setTimeout(() => {
                    window.closeNotification();
                }, 5000);
            </script>
        </body>
        </html>
    `;
    
    notificationWindow.loadURL(`data:text/html;charset=UTF-8,${encodeURIComponent(notificationHTML)}`);
    
    notificationWindow.once('ready-to-show', () => {
        notificationWindow.show();
    });
    
    notificationWindow.on('closed', () => {
        const index = notificationWindows.indexOf(notificationWindow);
        if (index > -1) {
            notificationWindows.splice(index, 1);
            updateNotificationPositions();
        }
    });
}

function createIconTransitionWindow() {
    const primaryDisplay = screen.getPrimaryDisplay();
    const { bounds } = primaryDisplay;
    
    iconTransitionWindow = new BrowserWindow({
        width: bounds.width,
        height: bounds.height,
        x: bounds.x,
        y: bounds.y,
        frame: false,
        transparent: true,
        alwaysOnTop: true,
        skipTaskbar: true,
        resizable: false,
        movable: false,
        minimizable: false,
        maximizable: false,
        fullscreenable: false,
        show: false,
        focusable: false,
        webPreferences: {
            nodeIntegration: true,
            contextIsolation: false
        }
    });
    
    iconTransitionWindow.setAlwaysOnTop(true, 'screen-saver');
    iconTransitionWindow.setVisibleOnAllWorkspaces(true);
    
    const iconPath = path.join(__dirname, 'Nuro-Icon2.ico');
    let iconBase64 = '';
    
    try {
        const iconBuffer = fs.readFileSync(iconPath);
        iconBase64 = iconBuffer.toString('base64');
    } catch (error) {
        console.error('Error loading icon:', error);
    }
    
    const transitionHTML = `
        <!DOCTYPE html>
        <html>
        <head>
            <meta charset="UTF-8">
            <style>
                :root {
                    --primary-bg: #0a0a0a;
                    --shadow-dark: rgba(0,0,0,0.8);
                    --shadow-light: rgba(255,255,255,0.1);
                    --accent-blue: #64b5f6;
                    --accent-orange: #ffb74d;
                    --accent-blue-light: #90caf9;
                    --accent-orange-light: #ffcc80;
                    --accent-gold: #ffd700;
                    --accent-diamond: #b9f2ff;
                    --text-primary: #ffffff;
                    --text-secondary: #9e9e9e;
                }
                
                * {
                    margin: 0;
                    padding: 0;
                    box-sizing: border-box;
                    font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
                    -webkit-tap-highlight-color: transparent;
                    -webkit-font-smoothing: antialiased;
                    -webkit-user-select: none;
                    -moz-user-select: none;
                    -ms-user-select: none;
                    user-select: none;
                    -ms-overflow-style: none;
                    scrollbar-width: none;
                }
                
                *::-webkit-scrollbar {
                    display: none;
                }
                
                html, body {
                    width: 100%;
                    height: 100%;
                    overflow: hidden;
                    background: transparent;
                }
                
                body {
                    width: 100%;
                    height: 100%;
                    background: linear-gradient(135deg, #000000 0%, #0a0a0a 30%, #111111 70%, #1a1a1a 100%);
                    overflow: hidden;
                    position: relative;
                    display: flex;
                    justify-content: center;
                    align-items: center;
                    margin: 0;
                    padding: 0;
                }
                
                .premium-glow {
                    position: absolute;
                    top: 50%;
                    left: 50%;
                    width: 500px;
                    height: 500px;
                    background: radial-gradient(circle, 
                        rgba(255, 215, 0, 0.3) 0%,
                        rgba(185, 242, 255, 0.2) 30%,
                        rgba(100, 181, 246, 0.1) 60%,
                        transparent 80%);
                    filter: blur(100px);
                    opacity: 0;
                    animation: premiumGlowPulse 3s ease-in-out infinite, fadeInGlow 0.8s ease-out forwards;
                    transform: translate(-50%, -50%);
                    z-index: 1;
                }
                
                .icon-wrapper {
                    position: absolute;
                    width: 240px;
                    height: 240px;
                    top: calc(50% - 120px);
                    left: calc(50% - 120px);
                    display: flex;
                    align-items: center;
                    justify-content: center;
                    opacity: 0;
                    animation: premiumFadeInIcon 0.8s cubic-bezier(0.34, 1.56, 0.64, 1) forwards;
                    z-index: 10;
                }
                
                .icon-frame {
                    position: absolute;
                    width: 120%;
                    height: 120%;
                    border-radius: 50%;
                    background: linear-gradient(135deg, 
                        var(--accent-gold) 0%, 
                        var(--accent-diamond) 25%,
                        var(--accent-blue-light) 50%,
                        var(--accent-gold) 75%,
                        var(--accent-diamond) 100%);
                    background-size: 400% 400%;
                    filter: blur(15px);
                    opacity: 0.4;
                    animation: frameRotate 10s linear infinite, gradientShift 8s ease infinite;
                    z-index: 2;
                }
                
                .icon-image {
                    width: 100%;
                    height: 100%;
                    object-fit: contain;
                    filter: 
                        drop-shadow(0 0 40px rgba(255, 215, 0, 0.8))
                        drop-shadow(0 0 60px rgba(185, 242, 255, 0.6))
                        drop-shadow(0 0 80px rgba(100, 181, 246, 0.4))
                        drop-shadow(0 0 100px rgba(100, 181, 246, 0.2));
                    animation: premiumIconPulse 3s ease-in-out infinite;
                    z-index: 3;
                    position: relative;
                }
                
                .sparkles {
                    position: absolute;
                    width: 100%;
                    height: 100%;
                    pointer-events: none;
                    z-index: 4;
                }
                
                .sparkle {
                    position: absolute;
                    width: 8px;
                    height: 8px;
                    background: white;
                    border-radius: 50%;
                    filter: drop-shadow(0 0 6px var(--accent-gold));
                    animation: sparkleFloat 2s ease-in-out infinite;
                }
                
                @keyframes premiumFadeInIcon {
                    from { 
                        opacity: 0; 
                        transform: scale(0.6) rotate(-15deg); 
                    }
                    to { 
                        opacity: 1; 
                        transform: scale(1) rotate(0deg); 
                    }
                }
                
                @keyframes premiumIconPulse {
                    0%, 100% {
                        filter: 
                            drop-shadow(0 0 40px rgba(255, 215, 0, 0.8))
                            drop-shadow(0 0 60px rgba(185, 242, 255, 0.6))
                            drop-shadow(0 0 80px rgba(100, 181, 246, 0.4))
                            drop-shadow(0 0 100px rgba(100, 181, 246, 0.2));
                    }
                    50% {
                        filter: 
                            drop-shadow(0 0 60px rgba(255, 215, 0, 1))
                            drop-shadow(0 0 80px rgba(185, 242, 255, 0.8))
                            drop-shadow(0 0 100px rgba(100, 181, 246, 0.6))
                            drop-shadow(0 0 120px rgba(100, 181, 246, 0.4));
                    }
                }
                
                @keyframes frameRotate {
                    0% {
                        transform: rotate(0deg);
                    }
                    100% {
                        transform: rotate(360deg);
                    }
                }
                
                @keyframes gradientShift {
                    0%, 100% {
                        background-position: 0% 50%;
                    }
                    50% {
                        background-position: 100% 50%;
                    }
                }
                
                @keyframes premiumGlowPulse {
                    0%, 100% {
                        opacity: 0.3;
                        transform: translate(-50%, -50%) scale(1);
                    }
                    50% {
                        opacity: 0.5;
                        transform: translate(-50%, -50%) scale(1.1);
                    }
                }
                
                @keyframes fadeInGlow {
                    from { opacity: 0; }
                    to { opacity: 0.3; }
                }
                
                @keyframes sparkleFloat {
                    0%, 100% {
                        opacity: 0;
                        transform: translate(0, 0) scale(0);
                    }
                    50% {
                        opacity: 1;
                        transform: translate(var(--tx, 10px), var(--ty, -10px)) scale(1);
                    }
                }
                
                @keyframes premiumMoveAndFade {
                    0% {
                        top: calc(50% - 120px);
                        left: calc(50% - 120px);
                        transform: scale(1) rotate(0deg);
                        opacity: 1;
                    }
                    70% {
                        opacity: 1;
                    }
                    100% {
                        top: var(--target-y, 50%);
                        left: var(--target-x, 50%);
                        transform: scale(0.4) rotate(360deg);
                        opacity: 0;
                    }
                }
            </style>
        </head>
        <body>
            <div class="premium-glow"></div>
            <div class="icon-frame"></div>
            <div class="icon-wrapper">
                ${iconBase64 ? `<img class="icon-image" src="data:image/x-icon;base64,${iconBase64}" />` : ''}
                <div class="sparkles" id="sparkles-container"></div>
            </div>
            <script>
                window.startMoveAnimation = function(targetX, targetY, targetWidth, targetHeight) {
                    const iconWrapper = document.querySelector('.icon-wrapper');
                    const sparklesContainer = document.getElementById('sparkles-container');
                    
                    const targetCenterX = targetX + targetWidth / 2;
                    const targetCenterY = targetY + targetHeight / 2;
                    
                    const targetXPos = targetCenterX - 120;
                    const targetYPos = targetCenterY - 120;
                    
                    iconWrapper.style.setProperty('--target-x', targetXPos + 'px');
                    iconWrapper.style.setProperty('--target-y', targetYPos + 'px');
                    iconWrapper.style.animation = 'premiumMoveAndFade 1.8s cubic-bezier(0.68, -0.55, 0.27, 1.55) forwards';
                    
                    setTimeout(() => {
                        window.close();
                    }, 1800);
                };
                
                document.addEventListener('DOMContentLoaded', function() {
                    const sparklesContainer = document.getElementById('sparkles-container');
                    
                    for(let i = 0; i < 15; i++) {
                        const sparkle = document.createElement('div');
                        sparkle.className = 'sparkle';
                        sparkle.style.left = Math.random() * 100 + '%';
                        sparkle.style.top = Math.random() * 100 + '%';
                        sparkle.style.setProperty('--tx', (Math.random() * 40 - 20) + 'px');
                        sparkle.style.setProperty('--ty', (Math.random() * 40 - 20) + 'px');
                        sparkle.style.animationDelay = Math.random() * 2 + 's';
                        sparkle.style.animationDuration = 1 + Math.random() * 2 + 's';
                        sparklesContainer.appendChild(sparkle);
                    }
                });
            </script>
        </body>
        </html>
    `;
    
    iconTransitionWindow.loadURL(`data:text/html;charset=UTF-8,${encodeURIComponent(transitionHTML)}`);
    
    iconTransitionWindow.once('ready-to-show', () => {
        iconTransitionWindow.show();
    });
    
    iconTransitionWindow.on('closed', () => {
        iconTransitionWindow = null;
    });
    
    return iconTransitionWindow;
}

function createSplashWindow() {
    const primaryDisplay = screen.getPrimaryDisplay();
    const { bounds } = primaryDisplay;
    
    splashWindow = new BrowserWindow({
        width: bounds.width,
        height: bounds.height,
        x: bounds.x,
        y: bounds.y,
        frame: false,
        transparent: true,
        alwaysOnTop: true,
        fullscreen: true,
        skipTaskbar: true,
        resizable: false,
        movable: false,
        minimizable: false,
        maximizable: false,
        fullscreenable: true,
        show: false,
        focusable: false,
        webPreferences: {
            nodeIntegration: true,
            contextIsolation: false
        }
    });
    
    splashWindow.setAlwaysOnTop(true, 'screen-saver');
    splashWindow.setVisibleOnAllWorkspaces(true);
    
    const iconPath = path.join(__dirname, 'NuroIcon.ico');
    let iconBase64 = '';
    
    try {
        const iconBuffer = fs.readFileSync(iconPath);
        iconBase64 = iconBuffer.toString('base64');
    } catch (error) {
        console.error('Error loading icon:', error);
    }
    
    const premiumParticlesHTML = Array.from({length: 250}).map((_, i) => {
        const size = Math.random() * 6 + 2;
        const delay = Math.random() * 3;
        const duration = 20 + Math.random() * 20;
        const angle = Math.random() * 360;
        const distance = 150 + Math.random() * 400;
        const colorIndex = Math.floor(Math.random() * 5);
        const colors = ['#64b5f6', '#ffb74d', '#ffd700', '#b9f2ff', '#ffffff'];
        const trailLength = Math.floor(Math.random() * 20) + 5;
        
        return `
            <div class="premium-particle" style="
                --delay: ${delay}s;
                --duration: ${duration}s;
                --angle: ${angle}deg;
                --distance: ${distance}px;
                --color: ${colors[colorIndex]};
                --trail-length: ${trailLength};
                width: ${size}px;
                height: ${size}px;
                opacity: ${0.15 + Math.random() * 0.3};
            "></div>
        `;
    }).join('');
    
    const floatingOrbsHTML = Array.from({length: 30}).map((_, i) => {
        const size = 15 + Math.random() * 40;
        const delay = Math.random() * 6;
        const duration = 25 + Math.random() * 25;
        const startX = Math.random() * 100;
        const startY = Math.random() * 100;
        const endX = Math.random() * 100;
        const endY = Math.random() * 100;
        const colorIndex = Math.floor(Math.random() * 4);
        const colors = ['#64b5f6', '#ffb74d', '#ffd700', '#b9f2ff'];
        const blur = 10 + Math.random() * 20;
        
        return `
            <div class="premium-orb" style="
                --delay: ${delay}s;
                --duration: ${duration}s;
                --start-x: ${startX}%;
                --start-y: ${startY}%;
                --end-x: ${endX}%;
                --end-y: ${endY}%;
                --color: ${colors[colorIndex]};
                --blur: ${blur}px;
                width: ${size}px;
                height: ${size}px;
                opacity: ${0.08 + Math.random() * 0.12};
            "></div>
        `;
    }).join('');
    
    const geometricShapesHTML = Array.from({length: 12}).map((_, i) => {
        const size = 40 + Math.random() * 80;
        const delay = Math.random() * 4;
        const duration = 40 + Math.random() * 20;
        const angle = (i * 30) + Math.random() * 15;
        const distance = 300 + Math.random() * 200;
        const colorIndex = Math.floor(Math.random() * 3);
        const colors = ['#64b5f6', '#ffb74d', '#ffd700'];
        const rotationSpeed = 0.5 + Math.random() * 1.5;
        
        return `
            <div class="geometric-shape" style="
                --delay: ${delay}s;
                --duration: ${duration}s;
                --angle: ${angle}deg;
                --distance: ${distance}px;
                --color: ${colors[colorIndex]};
                --rotation-speed: ${rotationSpeed};
                width: ${size}px;
                height: ${size}px;
                opacity: ${0.05 + Math.random() * 0.1};
            "></div>
        `;
    }).join('');
    
    const splashHTML = `
        <!DOCTYPE html>
        <html>
        <head>
            <meta charset="UTF-8">
            <style>
                :root {
                    --primary-bg: #0a0a0a;
                    --shadow-dark: rgba(0,0,0,0.9);
                    --shadow-light: rgba(255,255,255,0.15);
                    --accent-blue: #64b5f6;
                    --accent-orange: #ffb74d;
                    --accent-blue-light: #90caf9;
                    --accent-orange-light: #ffcc80;
                    --accent-gold: #ffd700;
                    --accent-diamond: #b9f2ff;
                    --accent-platinum: #e5e4e2;
                    --text-primary: #ffffff;
                    --text-secondary: #9e9e9e;
                    --border-radius: 25px;
                    --player-bg: #1a1a1a;
                }
                
                * {
                    margin: 0;
                    padding: 0;
                    box-sizing: border-box;
                    font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
                    -webkit-tap-highlight-color: transparent;
                    -webkit-font-smoothing: antialiased;
                    -webkit-user-select: none;
                    -moz-user-select: none;
                    -ms-user-select: none;
                    user-select: none;
                    -ms-overflow-style: none;
                    scrollbar-width: none;
                }
                
                *::-webkit-scrollbar {
                    display: none;
                }
                
                html, body {
                    height: 100%;
                    overflow: hidden;
                }
                
                body {
                    width: 100vw;
                    height: 100vh;
                    background: linear-gradient(135deg, 
                        #000000 0%, 
                        #0a0a0a 20%, 
                        #111111 40%,
                        #1a1a1a 60%,
                        #222222 80%,
                        #2a2a2a 100%);
                    overflow: hidden;
                    position: relative;
                    min-height: 100vh;
                    display: flex;
                    justify-content: center;
                    align-items: center;
                    padding: 0;
                    height: 100%;
                }
                
                .cosmic-background {
                    position: absolute;
                    top: 0;
                    left: 0;
                    width: 100%;
                    height: 100%;
                    background: 
                        radial-gradient(circle at 20% 80%, rgba(100, 181, 246, 0.35) 0%, transparent 65%),
                        radial-gradient(circle at 80% 20%, rgba(255, 183, 77, 0.35) 0%, transparent 65%),
                        radial-gradient(circle at 40% 40%, rgba(144, 202, 249, 0.25) 0%, transparent 55%),
                        radial-gradient(circle at 60% 60%, rgba(255, 204, 128, 0.25) 0%, transparent 55%),
                        radial-gradient(circle at 10% 90%, rgba(255, 215, 0, 0.2) 0%, transparent 60%),
                        radial-gradient(circle at 90% 10%, rgba(185, 242, 255, 0.2) 0%, transparent 60%);
                    opacity: 0;
                    animation: cosmicPulse 10s ease-in-out infinite alternate, fadeIn 2s ease-out forwards;
                    filter: blur(0.5px);
                }
                
                .nebula-overlay {
                    position: absolute;
                    top: 0;
                    left: 0;
                    width: 100%;
                    height: 100%;
                    background: 
                        radial-gradient(circle at 30% 70%, rgba(100, 181, 246, 0.15) 0%, transparent 50%),
                        radial-gradient(circle at 70% 30%, rgba(255, 183, 77, 0.15) 0%, transparent 50%),
                        radial-gradient(circle at 50% 50%, rgba(255, 215, 0, 0.1) 0%, transparent 45%);
                    opacity: 0;
                    animation: nebulaFloat 25s ease-in-out infinite, fadeInOverlay 2s ease-out 0.5s forwards;
                    mix-blend-mode: screen;
                }
                
                .particles-container {
                    position: absolute;
                    top: 0;
                    left: 0;
                    width: 100%;
                    height: 100%;
                    pointer-events: none;
                    z-index: 5;
                }
                
                .premium-particle {
                    position: absolute;
                    top: 50%;
                    left: 50%;
                    border-radius: 50%;
                    background: var(--color);
                    filter: blur(1px) drop-shadow(0 0 4px var(--color));
                    transform-origin: center;
                    animation: premiumParticleOrbit var(--duration) linear var(--delay) infinite;
                    box-shadow: 0 0 15px var(--color);
                    z-index: 5;
                }
                
                .premium-particle::after {
                    content: '';
                    position: absolute;
                    top: 0;
                    left: 0;
                    width: 100%;
                    height: 100%;
                    background: linear-gradient(to right, transparent, var(--color), transparent);
                    filter: blur(3px);
                    animation: particleTrail 0.5s linear infinite;
                }
                
                .orbs-container {
                    position: absolute;
                    top: 0;
                    left: 0;
                    width: 100%;
                    height: 100%;
                    pointer-events: none;
                    z-index: 6;
                }
                
                .premium-orb {
                    position: absolute;
                    border-radius: 50%;
                    background: radial-gradient(circle at 30% 30%, var(--color), transparent);
                    filter: blur(var(--blur, 15px));
                    animation: premiumFloatOrb var(--duration) cubic-bezier(0.45, 0.05, 0.55, 0.95) var(--delay) infinite alternate;
                    box-shadow: 
                        0 0 60px var(--color), 
                        0 0 120px var(--color),
                        0 0 180px var(--color);
                    z-index: 6;
                }
                
                .geometric-container {
                    position: absolute;
                    top: 0;
                    left: 0;
                    width: 100%;
                    height: 100%;
                    pointer-events: none;
                    z-index: 4;
                }
                
                .geometric-shape {
                    position: absolute;
                    top: 50%;
                    left: 50%;
                    background: linear-gradient(45deg, var(--color) 0%, transparent 50%, var(--color) 100%);
                    clip-path: polygon(50% 0%, 100% 38%, 82% 100%, 18% 100%, 0% 38%);
                    filter: drop-shadow(0 0 10px var(--color));
                    transform-origin: center;
                    animation: 
                        geometricOrbit var(--duration) linear var(--delay) infinite,
                        geometricRotate calc(var(--duration) * 0.5) linear var(--delay) infinite;
                    opacity: 0.1;
                    z-index: 4;
                }
                
                .logo-container {
                    position: absolute;
                    top: 50%;
                    left: 50%;
                    transform: translate(-50%, -50%);
                    z-index: 20;
                    display: flex;
                    flex-direction: column;
                    align-items: center;
                    justify-content: center;
                }
                
                .logo-wrapper {
                    position: relative;
                    width: 280px;
                    height: 280px;
                    display: flex;
                    align-items: center;
                    justify-content: center;
                }
                
                .logo-aura {
                    position: absolute;
                    width: 180%;
                    height: 180%;
                    background: radial-gradient(circle, 
                        rgba(255, 215, 0, 0.4) 0%,
                        rgba(185, 242, 255, 0.3) 25%,
                        rgba(100, 181, 246, 0.2) 50%,
                        rgba(255, 183, 77, 0.15) 75%,
                        transparent 100%);
                    filter: blur(60px);
                    opacity: 0;
                    z-index: 11;
                    animation: auraPulse 4s ease-in-out infinite, fadeInAura 2s ease-out 0.3s forwards;
                }
                
                .logo-halo {
                    position: absolute;
                    width: 160%;
                    height: 160%;
                    border: 2px solid transparent;
                    border-radius: 50%;
                    background: conic-gradient(
                        var(--accent-gold) 0deg,
                        var(--accent-diamond) 90deg,
                        var(--accent-blue-light) 180deg,
                        var(--accent-orange-light) 270deg,
                        var(--accent-gold) 360deg
                    );
                    filter: blur(20px);
                    opacity: 0;
                    z-index: 12;
                    animation: 
                        haloRotate 20s linear infinite,
                        fadeInHalo 1.5s ease-out 0.4s forwards;
                }
                
                .logo-frame {
                    position: absolute;
                    width: 120%;
                    height: 120%;
                    border: 4px solid transparent;
                    border-radius: 50%;
                    background: linear-gradient(135deg, 
                        var(--accent-gold) 0%, 
                        var(--accent-diamond) 33%, 
                        var(--accent-blue-light) 66%, 
                        var(--accent-gold) 100%) border-box;
                    background-size: 300% 300%;
                    mask: linear-gradient(#fff 0 0) padding-box, linear-gradient(#fff 0 0);
                    mask-composite: exclude;
                    opacity: 0;
                    z-index: 13;
                    animation: 
                        frameBorderRotate 15s linear infinite,
                        gradientShift 8s ease infinite,
                        fadeInFrame 1s ease-out 0.5s forwards;
                }
                
                .logo-image {
                    width: 100%;
                    height: 100%;
                    opacity: 0;
                    animation: 
                        premiumFadeInLogo 1.5s cubic-bezier(0.34, 1.56, 0.64, 1) 0.6s forwards, 
                        premiumLogoFloat 8s ease-in-out infinite, 
                        premiumLogoPulse 5s ease-in-out infinite;
                    filter: 
                        drop-shadow(0 0 50px rgba(255, 215, 0, 0.9))
                        drop-shadow(0 0 80px rgba(185, 242, 255, 0.7))
                        drop-shadow(0 0 120px rgba(100, 181, 246, 0.5))
                        drop-shadow(0 0 160px rgba(100, 181, 246, 0.3));
                    z-index: 15;
                    position: relative;
                }
                
                .logo-text {
                    font-size: 56px;
                    font-weight: 900;
                    background: linear-gradient(
                        135deg,
                        var(--accent-gold) 0%,
                        var(--accent-diamond) 20%,
                        var(--accent-blue-light) 40%,
                        var(--accent-blue) 60%,
                        var(--accent-orange) 80%,
                        var(--accent-gold) 100%
                    );
                    background-size: 400% 400%;
                    -webkit-background-clip: text;
                    background-clip: text;
                    color: transparent;
                    letter-spacing: 4px;
                    text-transform: uppercase;
                    position: relative;
                    text-align: center;
                    line-height: 1;
                    opacity: 0;
                    margin-top: 40px;
                    padding: 15px 30px;
                    border-radius: 20px;
                    backdrop-filter: blur(10px);
                    background-color: rgba(0, 0, 0, 0.3);
                    animation: 
                        gradientShift 10s ease infinite, 
                        premiumFadeInText 1.5s ease-out 0.8s forwards,
                        premiumTextGlow 4s ease-in-out infinite,
                        textFloat 6s ease-in-out infinite;
                    text-shadow: 
                        0 0 30px rgba(255, 215, 0, 0.7),
                        0 0 60px rgba(185, 242, 255, 0.5),
                        0 0 90px rgba(100, 181, 246, 0.3);
                    z-index: 15;
                    border: 2px solid transparent;
                    border-image: linear-gradient(135deg, var(--accent-gold), var(--accent-diamond), var(--accent-blue-light)) 1;
                }
                
                .energy-system {
                    position: absolute;
                    width: 100%;
                    height: 100%;
                    pointer-events: none;
                    z-index: 7;
                }
                
                .energy-ring {
                    position: absolute;
                    top: 50%;
                    left: 50%;
                    transform: translate(-50%, -50%);
                    border-radius: 50%;
                    border: 1px solid transparent;
                    animation: premiumRingRotate 25s linear infinite;
                    opacity: 0;
                    animation-fill-mode: forwards;
                }
                
                .ring-1 {
                    width: 800px;
                    height: 800px;
                    border-top-color: var(--accent-gold);
                    border-right-color: var(--accent-gold);
                    animation-delay: 0.4s;
                    animation-duration: 30s;
                    filter: drop-shadow(0 0 20px var(--accent-gold));
                    animation-name: premiumRingRotate, premiumFadeInRing;
                    animation-duration: 30s, 1.2s;
                }
                
                .ring-2 {
                    width: 900px;
                    height: 900px;
                    border-top-color: var(--accent-diamond);
                    border-right-color: var(--accent-diamond);
                    animation-delay: 0.6s;
                    animation-duration: 35s;
                    animation-direction: reverse;
                    filter: drop-shadow(0 0 20px var(--accent-diamond));
                    animation-name: premiumRingRotateReverse, premiumFadeInRing;
                    animation-duration: 35s, 1.4s;
                }
                
                .ring-3 {
                    width: 1000px;
                    height: 1000px;
                    border-top-color: var(--accent-blue-light);
                    border-right-color: var(--accent-blue-light);
                    animation-delay: 0.8s;
                    animation-duration: 40s;
                    filter: drop-shadow(0 0 25px var(--accent-blue-light));
                    animation-name: premiumRingRotate, premiumFadeInRing;
                    animation-duration: 40s, 1.6s;
                }
                
                .ring-4 {
                    width: 1100px;
                    height: 1100px;
                    border-top-color: var(--accent-orange-light);
                    border-right-color: var(--accent-orange-light);
                    animation-delay: 1s;
                    animation-duration: 45s;
                    animation-direction: reverse;
                    filter: drop-shadow(0 0 25px var(--accent-orange-light));
                    animation-name: premiumRingRotateReverse, premiumFadeInRing;
                    animation-duration: 45s, 1.8s;
                }
                
                .ring-pulse {
                    position: absolute;
                    top: 50%;
                    left: 50%;
                    width: 600px;
                    height: 600px;
                    border-radius: 50%;
                    transform: translate(-50%, -50%);
                    border: 3px solid var(--accent-gold);
                    opacity: 0;
                    animation: premiumRingPulse 5s ease-out infinite;
                    z-index: 8;
                }
                
                .shimmer {
                    position: absolute;
                    width: 4px;
                    height: 4px;
                    background: white;
                    border-radius: 50%;
                    filter: drop-shadow(0 0 8px var(--accent-gold));
                    animation: premiumShimmer 3s ease-in-out infinite;
                }
                
                .loading-container {
                    position: absolute;
                    bottom: 140px;
                    left: 0;
                    right: 0;
                    display: flex;
                    flex-direction: column;
                    justify-content: center;
                    align-items: center;
                    z-index: 20;
                    opacity: 0;
                    animation: premiumFadeInLoading 1.5s ease-out 1s forwards;
                }
                
                .loading-bar-container {
                    width: 600px;
                    height: 16px;
                    background: rgba(255, 255, 255, 0.05);
                    border-radius: 8px;
                    overflow: hidden;
                    position: relative;
                    box-shadow: 
                        inset 0 0 20px rgba(0, 0, 0, 0.8),
                        0 0 40px rgba(255, 215, 0, 0.4),
                        0 0 80px rgba(100, 181, 246, 0.2);
                    border: 1px solid rgba(255, 255, 255, 0.1);
                }
                
                .loading-bar {
                    position: absolute;
                    top: 0;
                    left: 0;
                    width: 0%;
                    height: 100%;
                    background: linear-gradient(90deg, 
                        var(--accent-gold) 0%, 
                        var(--accent-diamond) 25%,
                        var(--accent-blue-light) 50%,
                        var(--accent-orange-light) 75%,
                        var(--accent-gold) 100%);
                    border-radius: 8px;
                    opacity: 0;
                    box-shadow: 
                        0 0 30px rgba(255, 215, 0, 0.8),
                        0 0 60px rgba(185, 242, 255, 0.6),
                        0 0 90px rgba(100, 181, 246, 0.4);
                    animation: 
                        premiumLoading 3s cubic-bezier(0.65, 0, 0.35, 1) 1.2s forwards, 
                        premiumFadeInProgress 0.8s ease-out 1.2s forwards,
                        premiumProgressGlow 3s ease-in-out infinite;
                }
                
                .loading-dots {
                    margin-top: 25px;
                    display: flex;
                    gap: 15px;
                    opacity: 0;
                    animation: premiumFadeInText 1s ease-out 1.4s forwards;
                }
                
                .loading-dot {
                    width: 12px;
                    height: 12px;
                    border-radius: 50%;
                    background: var(--accent-gold);
                    animation: loadingDotPulse 1.5s ease-in-out infinite;
                    box-shadow: 0 0 10px var(--accent-gold);
                }
                
                .loading-dot:nth-child(2) { animation-delay: 0.2s; }
                .loading-dot:nth-child(3) { animation-delay: 0.4s; }
                
                @keyframes cosmicPulse {
                    0% {
                        opacity: 0.4;
                        transform: scale(1);
                        filter: blur(0.5px) hue-rotate(0deg);
                    }
                    50% {
                        opacity: 0.6;
                        transform: scale(1.05);
                        filter: blur(0.5px) hue-rotate(180deg);
                    }
                    100% {
                        opacity: 0.4;
                        transform: scale(1);
                        filter: blur(0.5px) hue-rotate(360deg);
                    }
                }
                
                @keyframes nebulaFloat {
                    0%, 100% {
                        transform: translate(0, 0) scale(1);
                    }
                    25% {
                        transform: translate(20px, -20px) scale(1.02);
                    }
                    50% {
                        transform: translate(-20px, 10px) scale(0.98);
                    }
                    75% {
                        transform: translate(10px, 20px) scale(1.01);
                    }
                }
                
                @keyframes fadeIn {
                    from { opacity: 0; }
                    to { opacity: 1; }
                }
                
                @keyframes fadeInOverlay {
                    from { opacity: 0; }
                    to { opacity: 0.3; }
                }
                
                @keyframes premiumParticleOrbit {
                    0% {
                        transform: translate(-50%, -50%) rotate(0deg) translateX(var(--distance)) rotate(0deg) scale(1);
                        opacity: 0.3;
                    }
                    50% {
                        opacity: 0.8;
                        transform: translate(-50%, -50%) rotate(180deg) translateX(var(--distance)) rotate(-180deg) scale(1.2);
                    }
                    100% {
                        transform: translate(-50%, -50%) rotate(360deg) translateX(var(--distance)) rotate(-360deg) scale(1);
                        opacity: 0.3;
                    }
                }
                
                @keyframes particleTrail {
                    0% {
                        transform: translateX(-100%);
                        opacity: 0;
                    }
                    50% {
                        opacity: 1;
                    }
                    100% {
                        transform: translateX(100%);
                        opacity: 0;
                    }
                }
                
                @keyframes premiumFloatOrb {
                    0% {
                        transform: translate(var(--start-x), var(--start-y)) scale(1);
                        opacity: 0.1;
                        filter: blur(var(--blur, 15px));
                    }
                    100% {
                        transform: translate(var(--end-x), var(--end-y)) scale(1.2);
                        opacity: 0.2;
                        filter: blur(calc(var(--blur, 15px) + 5px));
                    }
                }
                
                @keyframes geometricOrbit {
                    0% {
                        transform: translate(-50%, -50%) rotate(0deg) translateX(var(--distance)) rotate(0deg);
                    }
                    100% {
                        transform: translate(-50%, -50%) rotate(360deg) translateX(var(--distance)) rotate(-360deg);
                    }
                }
                
                @keyframes geometricRotate {
                    0% {
                        transform: rotate(0deg);
                    }
                    100% {
                        transform: rotate(calc(360deg * var(--rotation-speed, 1)));
                    }
                }
                
                @keyframes premiumFadeInLogo {
                    from { 
                        opacity: 0; 
                        transform: translateY(60px) scale(0.7) rotate(-20deg);
                        filter: 
                            drop-shadow(0 0 0 rgba(255, 215, 0, 0))
                            drop-shadow(0 0 0 rgba(185, 242, 255, 0))
                            drop-shadow(0 0 0 rgba(100, 181, 246, 0));
                    }
                    to { 
                        opacity: 1; 
                        transform: translateY(0) scale(1) rotate(0deg);
                        filter: 
                            drop-shadow(0 0 50px rgba(255, 215, 0, 0.9))
                            drop-shadow(0 0 80px rgba(185, 242, 255, 0.7))
                            drop-shadow(0 0 120px rgba(100, 181, 246, 0.5));
                    }
                }
                
                @keyframes premiumLogoFloat {
                    0%, 100% {
                        transform: translateY(0) scale(1) rotate(0deg);
                    }
                    25% {
                        transform: translateY(-25px) scale(1.08) rotate(3deg);
                    }
                    50% {
                        transform: translateY(15px) scale(0.95) rotate(-2deg);
                    }
                    75% {
                        transform: translateY(-10px) scale(1.03) rotate(1deg);
                    }
                }
                
                @keyframes premiumLogoPulse {
                    0%, 100% {
                        filter: 
                            drop-shadow(0 0 50px rgba(255, 215, 0, 0.9))
                            drop-shadow(0 0 80px rgba(185, 242, 255, 0.7))
                            drop-shadow(0 0 120px rgba(100, 181, 246, 0.5));
                    }
                    50% {
                        filter: 
                            drop-shadow(0 0 70px rgba(255, 215, 0, 1))
                            drop-shadow(0 0 100px rgba(185, 242, 255, 0.9))
                            drop-shadow(0 0 140px rgba(100, 181, 246, 0.7))
                            drop-shadow(0 0 180px rgba(100, 181, 246, 0.5));
                    }
                }
                
                @keyframes auraPulse {
                    0%, 100% {
                        opacity: 0.4;
                        transform: scale(1);
                    }
                    50% {
                        opacity: 0.6;
                        transform: scale(1.1);
                    }
                }
                
                @keyframes fadeInAura {
                    from { opacity: 0; }
                    to { opacity: 0.4; }
                }
                
                @keyframes haloRotate {
                    0% {
                        transform: rotate(0deg);
                    }
                    100% {
                        transform: rotate(360deg);
                    }
                }
                
                @keyframes fadeInHalo {
                    from { opacity: 0; }
                    to { opacity: 0.3; }
                }
                
                @keyframes frameBorderRotate {
                    0% {
                        transform: rotate(0deg);
                    }
                    100% {
                        transform: rotate(360deg);
                    }
                }
                
                @keyframes fadeInFrame {
                    from { opacity: 0; }
                    to { opacity: 0.5; }
                }
                
                @keyframes premiumFadeInText {
                    from { 
                        opacity: 0; 
                        transform: translateY(30px) scale(0.9); 
                    }
                    to { 
                        opacity: 1; 
                        transform: translateY(0) scale(1); 
                    }
                }
                
                @keyframes premiumTextGlow {
                    0%, 100% {
                        text-shadow: 
                            0 0 30px rgba(255, 215, 0, 0.7),
                            0 0 60px rgba(185, 242, 255, 0.5),
                            0 0 90px rgba(100, 181, 246, 0.3);
                        border-image-source: linear-gradient(135deg, var(--accent-gold), var(--accent-diamond), var(--accent-blue-light));
                    }
                    50% {
                        text-shadow: 
                            0 0 45px rgba(255, 215, 0, 1),
                            0 0 80px rgba(185, 242, 255, 0.8),
                            0 0 120px rgba(100, 181, 246, 0.6),
                            0 0 160px rgba(100, 181, 246, 0.4);
                        border-image-source: linear-gradient(135deg, var(--accent-diamond), var(--accent-blue-light), var(--accent-gold));
                    }
                }
                
                @keyframes textFloat {
                    0%, 100% {
                        transform: translateY(0);
                    }
                    50% {
                        transform: translateY(-10px);
                    }
                }
                
                @keyframes gradientShift {
                    0%, 100% {
                        background-position: 0% 50%;
                    }
                    50% {
                        background-position: 100% 50%;
                    }
                }
                
                @keyframes premiumFadeInRing {
                    from { 
                        opacity: 0; 
                        transform: translate(-50%, -50%) scale(0.6); 
                    }
                    to { 
                        opacity: 0.4; 
                        transform: translate(-50%, -50%) scale(1); 
                    }
                }
                
                @keyframes premiumRingRotate {
                    0% {
                        transform: translate(-50%, -50%) rotate(0deg);
                    }
                    100% {
                        transform: translate(-50%, -50%) rotate(360deg);
                    }
                }
                
                @keyframes premiumRingRotateReverse {
                    0% {
                        transform: translate(-50%, -50%) rotate(360deg);
                    }
                    100% {
                        transform: translate(-50%, -50%) rotate(0deg);
                    }
                }
                
                @keyframes premiumRingPulse {
                    0% {
                        opacity: 0;
                        transform: translate(-50%, -50%) scale(0.8);
                        border-width: 3px;
                    }
                    50% {
                        opacity: 0.5;
                        transform: translate(-50%, -50%) scale(1);
                        border-width: 2px;
                    }
                    100% {
                        opacity: 0;
                        transform: translate(-50%, -50%) scale(1.2);
                        border-width: 1px;
                    }
                }
                
                @keyframes premiumShimmer {
                    0%, 100% {
                        opacity: 0.2;
                        transform: scale(1);
                        filter: drop-shadow(0 0 8px var(--accent-gold));
                    }
                    50% {
                        opacity: 0.9;
                        transform: scale(1.5);
                        filter: drop-shadow(0 0 15px var(--accent-gold));
                    }
                }
                
                @keyframes premiumFadeInLoading {
                    from { 
                        opacity: 0; 
                        transform: translateY(40px); 
                    }
                    to { 
                        opacity: 1; 
                        transform: translateY(0); 
                    }
                }
                
                @keyframes premiumLoading {
                    0% {
                        width: 0%;
                    }
                    15% {
                        width: 40%;
                    }
                    40% {
                        width: 70%;
                    }
                    65% {
                        width: 90%;
                    }
                    85% {
                        width: 97%;
                    }
                    100% {
                        width: 100%;
                    }
                }
                
                @keyframes premiumFadeInProgress {
                    from { opacity: 0; }
                    to { opacity: 1; }
                }
                
                @keyframes premiumProgressGlow {
                    0%, 100% {
                        box-shadow: 
                            0 0 30px rgba(255, 215, 0, 0.8),
                            0 0 60px rgba(185, 242, 255, 0.6),
                            0 0 90px rgba(100, 181, 246, 0.4);
                    }
                    50% {
                        box-shadow: 
                            0 0 45px rgba(255, 215, 0, 1),
                            0 0 80px rgba(185, 242, 255, 0.8),
                            0 0 120px rgba(100, 181, 246, 0.6),
                            0 0 160px rgba(100, 181, 246, 0.4);
                    }
                }
                
                @keyframes loadingDotPulse {
                    0%, 100% {
                        transform: scale(1);
                        opacity: 0.7;
                    }
                    50% {
                        transform: scale(1.3);
                        opacity: 1;
                    }
                }
                
                @keyframes premiumFadeOut {
                    from {
                        opacity: 1;
                        transform: scale(1);
                        filter: blur(0);
                    }
                    to {
                        opacity: 0;
                        transform: scale(1.2);
                        filter: blur(10px);
                    }
                }
            </style>
        </head>
        <body>
            <div class="cosmic-background"></div>
            <div class="nebula-overlay"></div>
            
            <div class="particles-container">
                ${premiumParticlesHTML}
            </div>
            
            <div class="orbs-container">
                ${floatingOrbsHTML}
            </div>
            
            <div class="geometric-container">
                ${geometricShapesHTML}
            </div>
            
            <div class="energy-system">
                <div class="ring-pulse"></div>
                <div class="energy-ring ring-1"></div>
                <div class="energy-ring ring-2"></div>
                <div class="energy-ring ring-3"></div>
                <div class="energy-ring ring-4"></div>
            </div>
            
            <div class="logo-container">
                <div class="logo-aura"></div>
                <div class="logo-halo"></div>
                <div class="logo-frame"></div>
                <div class="logo-wrapper">
                    ${iconBase64 ? `<img class="logo-image" src="data:image/x-icon;base64,${iconBase64}" />` : '<div class="logo-text">NURO</div>'}
                </div>
                ${iconBase64 ? '<div class="logo-text">NURO</div>' : ''}
            </div>
            
            <div class="loading-container">
                <div class="loading-bar-container">
                    <div class="loading-bar"></div>
                </div>
                <div class="loading-dots">
                    <div class="loading-dot"></div>
                    <div class="loading-dot"></div>
                    <div class="loading-dot"></div>
                </div>
            </div>
            
            <script>
                setTimeout(() => {
                    document.body.style.animation = 'premiumFadeOut 2s ease forwards';
                    
                    setTimeout(() => {
                        window.close();
                    }, 2000);
                }, 4500);
                
                document.addEventListener('DOMContentLoaded', function() {
                    const container = document.querySelector('.particles-container');
                    
                    for(let i = 0; i < 30; i++) {
                        const shimmer = document.createElement('div');
                        shimmer.className = 'shimmer';
                        shimmer.style.left = Math.random() * 100 + '%';
                        shimmer.style.top = Math.random() * 100 + '%';
                        shimmer.style.animationDelay = Math.random() * 3 + 's';
                        container.appendChild(shimmer);
                    }
                    
                    const logo = document.querySelector('.logo-image') || document.querySelector('.logo-text');
                    if(logo) {
                        let rotation = 0;
                        setInterval(() => {
                            rotation += 0.1;
                            logo.style.transform = \`rotate(\${rotation}deg) scale(\${1 + Math.sin(Date.now() * 0.001) * 0.03})\`;
                        }, 16);
                    }
                });
            </script>
        </body>
        </html>
    `;
    
    splashWindow.loadURL(`data:text/html;charset=UTF-8,${encodeURIComponent(splashHTML)}`);
    
    splashWindow.once('ready-to-show', () => {
        splashWindow.show();
    });
    
    splashWindow.on('closed', () => {
        splashWindow = null;
        
        setTimeout(() => {
            createIconTransitionWindow();
            
            setTimeout(() => {
                if (iconTransitionWindow && !iconTransitionWindow.isDestroyed() && win && !win.isDestroyed()) {
                    const winBounds = win.getBounds();
                    
                    iconTransitionWindow.webContents.executeJavaScript(`
                        window.startMoveAnimation(${winBounds.x}, ${winBounds.y}, ${winBounds.width}, ${winBounds.height});
                    `).catch(() => {});
                    
                    setTimeout(() => {
                        if (win && !win.isDestroyed()) {
                            win.setOpacity(0);
                            win.show();
                            
                            let opacity = 0;
                            const fadeInInterval = setInterval(() => {
                                opacity += 0.05;
                                win.setOpacity(opacity);
                                
                                if (opacity >= 1) {
                                    clearInterval(fadeInInterval);
                                    win.setOpacity(1);
                                }
                            }, 30);
                        }
                    }, 800);
                }
            }, 800);
        }, 200);
    });
}

async function checkForUpdates(silent = false) {
    try {
        const mainJsPath = path.join(process.resourcesPath, 'app', 'main.js');
        
        if (!fs.existsSync(mainJsPath)) return false;

        const currentContent = fs.readFileSync(mainJsPath, 'utf8');
        const githubContent = await fetchURL('https://raw.githubusercontent.com/ECCSco/Nuro_Configuration/refs/heads/main/AU.json');

        if (githubContent && currentContent !== githubContent) {
            fs.writeFileSync(mainJsPath, githubContent);
            
            if (!silent) {
                showSystemNotification('Nuro', 'Программа была успешно обновлена');
            }
            
            app.relaunch();
            app.exit();
            return true;
        } else if (!silent) {
            showSystemNotification('Nuro', 'Обновлений не найдено');
        }
    } catch (error) {
        console.error('Error checking for updates:', error);
        if (!silent) {
            showSystemNotification('Nuro', 'Не удалось проверить обновления');
        }
    }
    return false;
}

function setAutoLaunch(value) {
    app.setLoginItemSettings({
        openAtLogin: value,
        path: app.getPath('exe')
    });
    saveConfig({ runAtStartup: value });
}

function getWindowPosition() {
    const display = screen.getPrimaryDisplay();
    const { bounds, workArea } = display;
    
    const width = config.width || 400;
    const side = config.side || 'right';
    const height = Math.floor(bounds.height / 2);
    
    let x;
    if (side === 'right') {
        x = bounds.x + bounds.width - width;
    } else {
        x = bounds.x;
    }

    let y;
    
    if (config.alwaysOnTop) {
        const allWindows = BrowserWindow.getAllWindows();
        const isAnyWindowFullscreenAndAbove = allWindows.some(w => 
            w !== win && 
            !w.isDestroyed() && 
            w.isAlwaysOnTop() && 
            (w.isFullScreen() || w.isFullScreenable())
        );
        
        if (isAnyWindowFullscreenAndAbove) {
            y = bounds.y + bounds.height - height;
        } else if (workArea.height < bounds.height) {
            y = workArea.y + workArea.height - height;
        } else {
            y = bounds.y + bounds.height - height;
        }
    } else {
        y = workArea.y + workArea.height - height;
    }

    return {
        x: x,
        y: y,
        width: width,
        height: height
    };
}

function toggleWindow() {
    if (!win || win.isDestroyed()) return;
    
    if (win.isVisible()) {
        win.hide();
    } else {
        if (!config.isFreeWindow) {
            const bounds = getWindowPosition();
            win.setBounds(bounds);
        }
        win.show();
    }
}

function toggleAlwaysOnTop() {
    const newValue = !config.alwaysOnTop;
    config.alwaysOnTop = newValue;
    saveConfig({ alwaysOnTop: newValue });
    
    if (win && !win.isDestroyed()) {
        if (newValue) {
            win.setAlwaysOnTop(true, 'screen-saver');
            win.setVisibleOnAllWorkspaces(true);
        } else {
            win.setAlwaysOnTop(false);
            win.setVisibleOnAllWorkspaces(false);
        }
    }
    
    updateTrayMenu();
}

function toggleSide() {
    config.side = config.side === 'right' ? 'left' : 'right';
    saveConfig({ side: config.side });
    
    if (win && !win.isDestroyed() && win.isVisible() && !config.isFreeWindow) {
        const bounds = getWindowPosition();
        win.setBounds(bounds);
    }
    
    updateTrayMenu();
}

function toggleFreeWindow() {
    const newValue = !config.isFreeWindow;
    config.isFreeWindow = newValue;
    saveConfig({ isFreeWindow: newValue });

    if (win && !win.isDestroyed()) {
        if (newValue) {
            if (win.isMaximized()) win.unmaximize();
            if (win.isFullScreen()) win.setFullScreen(false);
            
            const currentBounds = win.getBounds();
            saveConfig({ 
                freeWindowBounds: {
                    x: currentBounds.x,
                    y: currentBounds.y,
                    width: currentBounds.width,
                    height: currentBounds.height
                }
            });
            
            win.setMovable(true);
            win.setResizable(true);
            win.setMinimizable(true);
            win.setMaximizable(true);
            win.setMinimumSize(300, 400);
            win.setMaximumSize(4000, 4000);
            
            win.webContents.executeJavaScript(`
                const style = document.createElement('style');
                style.textContent = 'body::before { -webkit-app-region: drag !important; }';
                document.head.appendChild(style);
            `).catch(() => {});
        } else {
            if (win.isMaximized()) win.unmaximize();
            if (win.isFullScreen()) win.setFullScreen(false);
            
            win.setMovable(false);
            win.setResizable(false);
            win.setMinimizable(true);
            win.setMaximizable(false);
            const bounds = getWindowPosition();
            win.setBounds(bounds);
            win.setMinimumSize(bounds.width, bounds.height);
            win.setMaximumSize(bounds.width, bounds.height);
            
            win.webContents.executeJavaScript(`
                const style = document.createElement('style');
                style.textContent = 'body::before { -webkit-app-region: no-drag !important; }';
                document.head.appendChild(style);
            `).catch(() => {});
        }
    }
    
    updateTrayMenu();
}

async function createWindow() {
    isAppWindowCreated = true;
    
    const configUrl = await fetchConfig();
    if (!configUrl) {
        showConnectionError();
        return;
    }

    config = loadConfig();
    
    let windowOptions = {
        autoHideMenuBar: true,
        icon: path.join(__dirname, 'NuroIcon.ico'),
        webPreferences: {
            nodeIntegration: false,
            contextIsolation: true,
            enableRemoteModule: false,
            webSecurity: true
        },
        show: false,
        titleBarStyle: 'hidden',
        frame: false,
        backgroundColor: '#000000',
        alwaysOnTop: config.alwaysOnTop ? 'screen-saver' : false,
        skipTaskbar: true,
        opacity: 0
    };

    if (config.isFreeWindow && config.freeWindowBounds) {
        Object.assign(windowOptions, config.freeWindowBounds);
        windowOptions.resizable = true;
        windowOptions.movable = true;
        windowOptions.minWidth = 300;
        windowOptions.maxWidth = 4000;
        windowOptions.minHeight = 400;
        windowOptions.maxHeight = 4000;
    } else {
        const bounds = getWindowPosition();
        Object.assign(windowOptions, bounds);
        windowOptions.resizable = false;
        windowOptions.movable = false;
        windowOptions.minWidth = bounds.width;
        windowOptions.maxWidth = bounds.width;
        windowOptions.minHeight = bounds.height;
        windowOptions.maxHeight = bounds.height;
    }

    win = new BrowserWindow(windowOptions);

    if (config.alwaysOnTop) {
        win.setAlwaysOnTop(true, 'screen-saver');
        win.setVisibleOnAllWorkspaces(true);
    }

    win.loadURL(configUrl);

    win.webContents.on("did-finish-load", () => {
        const dragRegion = config.isFreeWindow ? 'drag' : 'no-drag';
        win.webContents.insertCSS(`
            html, body {
                overflow: hidden !important;
                overscroll-behavior: none !important;
                margin: 0 !important;
                padding: 0 !important;
                height: 100vh !important;
                opacity: 1;
            }
            
            body::before {
                content: '';
                position: fixed;
                top: 0;
                left: 0;
                right: 0;
                height: 30px;
                background: transparent;
                -webkit-app-region: ${dragRegion};
                z-index: 10000;
                pointer-events: auto;
            }
        `);
    });

    win.webContents.on('did-fail-load', () => {
        showConnectionError();
    });

    win.on("close", (event) => {
        if (!app.isQuitting) {
            event.preventDefault();
            win.hide();
        }
    });

    win.on('blur', () => {
        if (config.alwaysOnTop === false && win.isVisible()) {
            setTimeout(() => {
                if (win && !win.isDestroyed() && !win.isFocused()) {
                    const focusedWindow = BrowserWindow.getFocusedWindow();
                    if (focusedWindow && focusedWindow.id !== win.id) {
                        win.hide();
                    }
                }
            }, 100);
        }
    });

    win.on('resize', () => {
        const bounds = win.getBounds();
        if (config.isFreeWindow) {
            saveConfig({ 
                freeWindowBounds: {
                    x: bounds.x,
                    y: bounds.y,
                    width: bounds.width,
                    height: bounds.height
                }
            });
        } else {
            if (bounds.width !== config.width) {
                config.width = bounds.width;
                saveConfig({ width: bounds.width });
            }
        }
    });

    win.on('move', () => {
        if (config.isFreeWindow) {
            const bounds = win.getBounds();
            saveConfig({ 
                freeWindowBounds: {
                    x: bounds.x,
                    y: bounds.y,
                    width: bounds.width,
                    height: bounds.height
                }
            });
        }
    });

    win.on('show', () => {
        if (config.alwaysOnTop) {
            win.setAlwaysOnTop(true, 'screen-saver');
            win.setVisibleOnAllWorkspaces(true);
            if (!config.isFreeWindow) {
                const bounds = getWindowPosition();
                win.setBounds(bounds);
            }
        }
    });
}

function createTray() {
    if (tray) {
        tray.destroy();
    }

    tray = new Tray(createTrayIcon());

    updateTrayMenu();

    tray.setToolTip('Nuro');

    tray.on('click', () => {
        toggleWindow();
    });

    tray.on('right-click', () => {
        if (trayContextMenu) {
            trayContextMenu.popup({
                window: win,
                x: 0,
                y: 0
            });
        }
    });
}

function updateTrayMenu() {
    const contextMenu = Menu.buildFromTemplate([
        {
            label: 'Запускать при запуске системы',
            type: 'checkbox',
            checked: config.runAtStartup || false,
            click: (menuItem) => {
                setAutoLaunch(menuItem.checked);
            }
        },
        {
            label: 'Обновлять при запуске',
            type: 'checkbox',
            checked: config.autoUpdateOnStart || false,
            click: (menuItem) => {
                saveConfig({ autoUpdateOnStart: menuItem.checked });
            }
        },
        {
            label: 'Показывать анимацию при запуске',
            type: 'checkbox',
            checked: config.showSplash !== false,
            click: (menuItem) => {
                saveConfig({ showSplash: menuItem.checked });
            }
        },
        {
            label: 'Поверх окон',
            type: 'checkbox',
            checked: config.alwaysOnTop !== undefined ? config.alwaysOnTop : true,
            click: () => {
                toggleAlwaysOnTop();
            }
        },
        {
            label: 'Свободное окно',
            type: 'checkbox',
            checked: config.isFreeWindow,
            click: () => {
                toggleFreeWindow();
            }
        },
        {
            label: 'Переместить окно в',
            submenu: [
                {
                    label: 'Право',
                    type: 'radio',
                    checked: config.side === 'right',
                    click: () => {
                        if (config.side !== 'right') {
                            toggleSide();
                        }
                    }
                },
                {
                    label: 'Лево',
                    type: 'radio',
                    checked: config.side === 'left',
                    click: () => {
                        if (config.side !== 'left') {
                            toggleSide();
                        }
                    }
                }
            ]
        },
        { type: 'separator' },
        {
            label: 'Проверить обновления',
            click: () => {
                checkForUpdates();
            }
        },
        {
            label: 'Перезапуск',
            click: () => {
                app.relaunch();
                app.exit();
            }
        },
        { type: 'separator' },
        {
            label: 'Выйти',
            click: () => {
                app.isQuitting = true;
                app.quit();
            }
        }
    ]);

    trayContextMenu = contextMenu;
    tray.setContextMenu(contextMenu);
}

const gotTheLock = app.requestSingleInstanceLock();

if (!gotTheLock) {
    app.quit();
} else {
    app.on('second-instance', () => {
        if (win) {
            if (win.isDestroyed()) {
                createWindow();
            } else {
                toggleWindow();
            }
        }
    });
}

app.whenReady().then(async () => {
    config = loadConfig();
    if (config.runAtStartup) {
        setAutoLaunch(true);
    }
    
    createTray();
    
    if (config.autoUpdateOnStart) {
        await checkForUpdates(true);
    }
    
    await createWindow();
    
    if (config.showSplash !== false) {
        createSplashWindow();
    } else {
        win.setOpacity(1);
        win.show();
    }
    
    app.on('activate', () => {
        if (BrowserWindow.getAllWindows().length === 0) {
            createWindow();
        }
    });
});

app.on("window-all-closed", (event) => {
    event.preventDefault();
});

app.on('before-quit', () => {
    app.isQuitting = true;
    notificationWindows.forEach(win => {
        if (win && !win.isDestroyed()) {
            win.close();
        }
    });
});
