const { app, BrowserWindow, Tray, Menu, screen, net, dialog, nativeImage } = require('electron');
const path = require('path');
const fs = require('fs');

let win;
let tray;
let config = {};

const configPath = path.join(app.getPath('userData'), 'config.json');

function loadConfig() {
    try {
        if (fs.existsSync(configPath)) {
            const configData = fs.readFileSync(configPath, 'utf8');
            return JSON.parse(configData);
        }
    } catch (error) {
        console.error('Error loading config:', error);
    }
    return {};
}

function saveConfig(newConfig) {
    try {
        config = { ...config, ...newConfig };
        fs.writeFileSync(configPath, JSON.stringify(config, null, 2));
    } catch (error) {
        console.error('Error saving config:', error);
    }
}

function createTrayIcon() {
    const image = nativeImage.createFromPath(path.join(__dirname, 'Nuro-Icon2.ico'));
    return image.resize({ width: 16, height: 16 });
}

function fetchConfig() {
    return new Promise((resolve) => {
        const request = net.request('https://raw.githubusercontent.com/ECCSco/Nuro_Configuration/refs/heads/main/config.json');
        request.on('response', (response) => {
            let data = '';
            response.on('data', (chunk) => {
                data += chunk;
            });
            response.on('end', () => {
                resolve(data.trim());
            });
        });
        request.on('error', () => resolve(null));
        request.end();
    });
}

function fetchURL(url) {
    return new Promise((resolve) => {
        const request = net.request(url);
        request.on('response', (response) => {
            let data = '';
            response.on('data', (chunk) => {
                data += chunk;
            });
            response.on('end', () => {
                resolve(data.trim());
            });
        });
        request.on('error', () => resolve(null));
        request.end();
    });
}

function showConnectionError() {
    dialog.showMessageBoxSync({
        type: 'error',
        title: 'Ошибка подключения',
        message: 'Сервис временно недоступен',
        detail: 'Приносим извинения за неудобства. Пожалуйста, повторите попытку позже.',
        buttons: ['Ок'],
        defaultId: 0,
        noLink: true
    });
    
    app.isQuitting = true;
    app.quit();
}

async function checkForUpdates() {
    try {
        const mainJsPath = path.join(process.resourcesPath, 'app', 'main.js');
        if (!fs.existsSync(mainJsPath)) return false;

        const currentContent = fs.readFileSync(mainJsPath, 'utf8');
        const githubContent = await fetchURL('https://raw.githubusercontent.com/ECCSco/Nuro_Configuration/refs/heads/main/AU.json');

        if (githubContent && currentContent !== githubContent) {
            const result = dialog.showMessageBoxSync({
                type: 'info',
                title: 'Обновление',
                message: 'Ваша версия приложения устарела.',
                detail: 'Рекомендуется установить обновление для корректной работы.',
                buttons: ['Установить обновление', 'Запустить все равно', 'Отмена'],
                defaultId: 0,
                cancelId: 2
            });

            if (result === 0) {
                fs.writeFileSync(mainJsPath, githubContent);
                app.relaunch();
                app.exit();
                return true;
            } else if (result === 2) {
                app.isQuitting = true;
                app.quit();
                return true;
            }
        }
    } catch (error) {
        console.error('Error checking for updates:', error);
    }
    return false;
}

function setAutoLaunch(value) {
    app.setLoginItemSettings({
        openAtLogin: value,
        path: app.getPath('exe')
    });
    saveConfig({ runAtStartup: value });
}

async function createWindow() {
    const configUrl = await fetchConfig();
    if (!configUrl) {
        showConnectionError();
        return;
    }

    config = loadConfig();
    const savedBounds = config.windowBounds || {};

    const cursorPoint = screen.getCursorScreenPoint();
    const display = screen.getDisplayNearestPoint(cursorPoint);
    const { workArea } = display;
    
    const width = savedBounds.width || 800;
    const height = savedBounds.height || 600;
    
    const winX = savedBounds.x || workArea.x + Math.max(0, (workArea.width - width) / 2);
    const winY = savedBounds.y || workArea.y + Math.max(0, (workArea.height - height) / 2);

    win = new BrowserWindow({
        width: width,
        height: height,
        x: winX,
        y: winY,
        autoHideMenuBar: true,
        icon: path.join(__dirname, 'NuroIcon.ico'),
        webPreferences: {
            nodeIntegration: false,
            contextIsolation: true,
            enableRemoteModule: false,
            webSecurity: true
        },
        show: false,
        opacity: 0,
        minWidth: 500,
        minHeight: 400,
        titleBarStyle: 'hidden',
        frame: false,
        backgroundColor: '#000000'
    });

    if (config.isFullScreen) {
        win.setFullScreen(true);
    }
    
    if (config.isAlwaysOnTop) {
        win.setAlwaysOnTop(true);
    }

    win.loadURL(configUrl);

    win.webContents.on("did-finish-load", () => {
        win.webContents.insertCSS(`
            html, body {
                overflow: hidden !important;
                overscroll-behavior: none !important;
                margin: 0 !important;
                padding: 0 !important;
            }
            
            .custom-titlebar {
                position: fixed;
                top: 0;
                left: 0;
                right: 0;
                height: 30px;
                background: transparent;
                -webkit-app-region: drag;
                display: flex;
                align-items: center;
                justify-content: center;
                z-index: 10000;
                backdrop-filter: blur(20px) saturate(1.4);
                -webkit-backdrop-filter: blur(20px) saturate(1.4);
                background: rgba(10, 25, 47, 0.85);
                border-bottom: 1px solid rgba(100, 181, 246, 0.3);
            }
            
            .titlebar-content {
                color: rgba(255, 255, 255, 0.9);
                font-size: 12px;
                font-weight: 600;
                text-shadow: 0 0 10px rgba(41, 182, 246, 0.4);
                -webkit-app-region: no-drag;
            }
            
            .titlebar-close {
                position: absolute;
                right: 10px;
                width: 12px;
                height: 12px;
                border-radius: 50%;
                background: #4fc3f7;
                border: none;
                cursor: pointer;
                transition: all 0.3s ease;
                display: flex;
                align-items: center;
                justify-content: center;
                -webkit-app-region: no-drag;
            }
            
            .titlebar-close:hover {
                background: #29b6f6;
                transform: scale(1.1);
                box-shadow: 0 0 8px rgba(41, 182, 246, 0.6);
            }
            
            .titlebar-close::before {
                content: '×';
                color: white;
                font-size: 10px;
                font-weight: bold;
                line-height: 1;
            }
            
            body {
                margin-top: 30px !important;
                height: calc(100vh - 30px) !important;
                overflow: auto !important;
            }
            
            #app, .app, .container, .root, [data-reactroot], [id*='root'], [class*='root'] {
                margin-top: 0 !important;
            }
        `);

        const titlebarHTML = `
            <div class="custom-titlebar">
                <div class="titlebar-content">Nuro</div>
                <button class="titlebar-close" id="titlebar-close"></button>
            </div>
        `;

        win.webContents.executeJavaScript(`
            if (!document.querySelector('.custom-titlebar')) {
                document.body.insertAdjacentHTML('afterbegin', \`${titlebarHTML}\`);
                
                const closeBtn = document.getElementById('titlebar-close');
                closeBtn.addEventListener('click', () => {
                    window.postMessage({ type: 'hide-window' }, '*');
                });
                
                const originalHeight = document.body.style.height;
                const originalMargin = document.body.style.marginTop;
                
                document.body.style.marginTop = '30px';
                document.body.style.height = 'calc(100vh - 30px)';
                
                const appContainers = [
                    document.getElementById('app'),
                    document.getElementById('root'),
                    document.querySelector('.app'),
                    document.querySelector('.container'),
                    document.querySelector('[data-reactroot]'),
                    document.querySelector('[id*="root"]'),
                    document.querySelector('[class*="root"]'),
                    document.querySelector('body > div:first-child')
                ];
                
                for (const container of appContainers) {
                    if (container && container.style) {
                        container.style.marginTop = '0';
                        container.style.height = '100%';
                    }
                }
            }

            window.addEventListener('message', (event) => {
                if (event.data.type === 'hide-window') {
                    require('electron').ipcRenderer.send('hide-window');
                }
            });
        `).catch(() => {});

        const observerScript = `
            let lastBackground = '';
            
            function updateTitlebarColor() {
                const titlebar = document.querySelector('.custom-titlebar');
                if (!titlebar) return;
                
                const bodyStyle = window.getComputedStyle(document.body);
                const bgColor = bodyStyle.backgroundColor;
                const bgImage = bodyStyle.backgroundImage;
                
                if (bgImage && bgImage !== 'none') {
                    titlebar.style.background = 'rgba(10, 25, 47, 0.85)';
                } else if (bgColor && bgColor !== 'rgba(0, 0, 0, 0)') {
                    const rgb = bgColor.match(/\\d+/g);
                    if (rgb) {
                        const [r, g, b] = rgb;
                        const brightness = (r * 299 + g * 587 + b * 114) / 1000;
                        if (brightness > 128) {
                            titlebar.style.background = 'rgba(255, 255, 255, 0.15)';
                            titlebar.style.borderBottom = '1px solid rgba(0, 0, 0, 0.2)';
                        } else {
                            titlebar.style.background = 'rgba(0, 0, 0, 0.15)';
                            titlebar.style.borderBottom = '1px solid rgba(255, 255, 255, 0.1)';
                        }
                    }
                }
            }
            
            const observer = new MutationObserver(updateTitlebarColor);
            observer.observe(document.body, {
                attributes: true,
                attributeFilter: ['style', 'class'],
                subtree: true,
                childList: true
            });
            
            setInterval(updateTitlebarColor, 1000);
            updateTitlebarColor();
        `;

        setTimeout(() => {
            win.webContents.executeJavaScript(observerScript).catch(() => {});
        }, 1000);
        
        win.show();
        let opacity = 0;
        const fadeInInterval = setInterval(() => {
            opacity += 0.04;
            win.setOpacity(opacity);
            
            if (opacity >= 1) {
                clearInterval(fadeInInterval);
                win.focus();
            }
        }, 30);
    });

    win.webContents.on('did-fail-load', () => {
        showConnectionError();
    });

    win.on("close", (event) => {
        if (!app.isQuitting) {
            event.preventDefault();
            win.hide();
        }
    });

    win.on('resize', () => {
        if (win && !win.isDestroyed() && !win.isMaximized() && !win.isMinimized() && !win.isFullScreen()) {
            const bounds = win.getBounds();
            saveConfig({ windowBounds: bounds });
        }
    });

    win.on('move', () => {
        if (win && !win.isDestroyed() && !win.isMaximized() && !win.isMinimized() && !win.isFullScreen()) {
            const bounds = win.getBounds();
            saveConfig({ windowBounds: bounds });
        }
    });

    win.on('enter-full-screen', () => {
        saveConfig({ isFullScreen: true });
        win.webContents.executeJavaScript(`
            document.querySelector('.custom-titlebar').style.display = 'none';
            document.body.style.marginTop = '0';
            document.body.style.height = '100vh';
        `).catch(() => {});
    });

    win.on('leave-full-screen', () => {
        saveConfig({ isFullScreen: false });
        win.webContents.executeJavaScript(`
            document.querySelector('.custom-titlebar').style.display = 'flex';
            document.body.style.marginTop = '30px';
            document.body.style.height = 'calc(100vh - 30px)';
        `).catch(() => {});
    });

    const { ipcMain } = require('electron');
    ipcMain.on('hide-window', () => {
        if (win && !win.isDestroyed()) {
            win.hide();
        }
    });
}

function createTray() {
    if (tray) {
        tray.destroy();
    }

    tray = new Tray(createTrayIcon());

    const contextMenu = Menu.buildFromTemplate([
        {
            label: 'Запускать при запуске системы',
            type: 'checkbox',
            checked: config.runAtStartup || false,
            click: (menuItem) => {
                setAutoLaunch(menuItem.checked);
            }
        },
        {
            label: 'Поверх окон',
            type: 'checkbox',
            checked: config.isAlwaysOnTop || false,
            click: () => {
                toggleAlwaysOnTop();
            }
        },
        { type: 'separator' },
        {
            label: 'Выйти',
            click: () => {
                app.isQuitting = true;
                app.quit();
            }
        }
    ]);

    tray.setToolTip('Nuro');
    tray.setContextMenu(contextMenu);

    tray.on('click', () => {
        if (win && !win.isDestroyed() && win.isVisible()) {
            win.hide();
        } else {
            showWindow();
        }
    });
}

function toggleAlwaysOnTop() {
    const newValue = !config.isAlwaysOnTop;
    saveConfig({ isAlwaysOnTop: newValue });
    
    if (win && !win.isDestroyed()) {
        win.setAlwaysOnTop(newValue);
    }
    
    updateTrayMenu();
}

function updateTrayMenu() {
    const contextMenu = Menu.buildFromTemplate([
        {
            label: 'Запускать при запуске системы',
            type: 'checkbox',
            checked: config.runAtStartup || false,
            click: (menuItem) => {
                setAutoLaunch(menuItem.checked);
            }
        },
        {
            label: 'Поверх окон',
            type: 'checkbox',
            checked: config.isAlwaysOnTop || false,
            click: () => {
                toggleAlwaysOnTop();
            }
        },
        { type: 'separator' },
        {
            label: 'Выйти',
            click: () => {
                app.isQuitting = true;
                app.quit();
            }
        }
    ]);

    tray.setContextMenu(contextMenu);
}

function showWindow() {
    if (win) {
        if (win.isDestroyed()) {
            createWindow();
            return;
        }
        
        const cursorPoint = screen.getCursorScreenPoint();
        const display = screen.getDisplayNearestPoint(cursorPoint);
        const { workArea } = display;
        
        const winBounds = win.getBounds();
        const maxWidth = Math.min(winBounds.width, workArea.width - 40);
        const maxHeight = Math.min(winBounds.height, workArea.height - 40);
        
        const winX = workArea.x + Math.max(0, (workArea.width - maxWidth) / 2);
        const winY = workArea.y + Math.max(0, (workArea.height - maxHeight) / 2);
        
        win.setBounds({
            x: winX,
            y: winY,
            width: maxWidth,
            height: maxHeight
        });
        
        win.show();
        win.focus();
    } else {
        createWindow();
    }
}

const gotTheLock = app.requestSingleInstanceLock();

if (!gotTheLock) {
    app.quit();
} else {
    app.on('second-instance', () => {
        showWindow();
    });
}

app.whenReady().then(async () => {
    config = loadConfig();
    if (config.runAtStartup) {
        setAutoLaunch(true);
    }
    
    const updateApplied = await checkForUpdates();
    if (!updateApplied) {
        createWindow();
        createTray();
    }
});

app.on("window-all-closed", (event) => {
    event.preventDefault();
});

app.on('before-quit', () => {
    app.isQuitting = true;
    
    if (win && !win.isDestroyed()) {
        const bounds = win.getBounds();
        saveConfig({ windowBounds: bounds });
    }
});
